## 타임테이블 서비스 소개
* 타임테이블 서비스는 가게에서 예약 가능한 주문을 담고 있는 서비스 입니다.
* 예약 가능자 수를 체크해 마이너스 혹은 플러스를 하여 예약 서비스에 적절한 bool 값을 리턴하는 역할도 합니다.
* 예약을 하기전 첫번째 관문역할을 합니다.
* 각 타임테이블 별로 예약 가능한 수를 조정하고, 저장하고 있기도 합니다.

등록시 권한검증 + 상점 검증(유저네임으로 상점 찾아서 id리턴 후 id랑 파라미터랑 검증하여 확인)

삭제존재

페이징 주의해야함(리밋 15개)

동시성을 제어하려면
예약을 할때 예약이 먼저 일어나면 안되고(서비스가 분리되어 있으니깐.)
타임테이블에서 커맨드를 처리하고 완료하여 리턴하면 나머지 예약 시스템이 동작한다.

단일 책임 원칙을 위해서 서비스 끼리는 종속적이면 안된다.
그러나 기존 설계는 너무 서비스끼리 종속적이다.
이를 분리하면
예약 서비스에서 타임테이블로 쿼리를 보내서 예약 가능자수를 마이너스한다.
이때 update쿼리가 불가능하여 에러를 내면 bool 값으로 false를 보내고,
성공한다면 true를 보낸다.
예약 서비스에서는 이를 validator로 체크하여 최종결과를 사용자에게 리턴한다.

## 서비스간 통신
provide controller로 예약 가능자수 마이너스 처리 후 bool 값 리턴
```
/reserve/timetable
```

상점 삭제시 타임테이블 삭제
```
topic : remove-timetable
request : shopId
```

상점 검증(유저네임 요청, 상점 id 리턴) 페인 클라이언트
```
url : /provide/shop/{username}
```

## 배치 - 후에 문서화
스케줄러를 이용해 새벽시간에 벌크연산으로 처리하도록 하면된다.(insert, update, delete)
배치는 반드시 로그 남긴다.
[스케줄러](https://itworldyo.tistory.com/40)

## 시간표 + 예약가능 수 구조
3개의 테이블이 필요함.
예약(주문처럼 예약 레코드? 예약한 예약) 테이블, 
가게 주인이 올린 예약, 하루 전체에 대한 예약
각 예약별 가능한 예약자 수
가게 주인이 올린 예약은 주인이 삭제하지 않는이상, 삭제되지 않음.
가게 주인이 예약을 등록하면 가능한 예약자 수 테이블에 예약자 수가 들어감(업데이트를 하게되면 이 테이블도 업데이트)
예약을 하면 가게 주인이 올린 예약에서 마이너스됨, 이때 예약 가능 수 테이블은 건들면 안됨
예약 가능 수 테이블은 가게 주인이 예약자 가능수를 변경할때 변경되는 것임.
하루가 지나 0시 1분이 되는 순간, 예약 가능 수 테이블에서 값을 가져와 배치(스케줄러)로 가게 주인이 올린 예약 수를 원복 시킴. 플러스나 마이너스 연산자가 아니라 아예 변경시키는 set연산자로 변경시킴
```
UPDATE TB1 A
  JOIN TB2 B
   SET A.AGE = B.AGE
 WHERE A.id = B.aId(fk);
```
[다른 테이블 참조해 전체 업데이트](https://lifelife7777.tistory.com/99)